
function buttonize (elem, callback) {
    var armed = false;
    var disabled = false;
    var selected = false;

    elem.addClass ('button');
    elem.setAttribute ('tabindex', '0');

    function controlFn (isDisabled, isSelected) {
        disabled = isDisabled;
        if (isSelected === undefined)
            return;
        elem.dropClass ('button_down');
        armed = false;
        if (isSelected && !selected) {
            elem.addClass ('button_pressed');
            selected = true;
        } else if (!isSelected && selected) {
            elem.dropClass ('button_pressed');
            selected = false;
        }
    }

    elem.on ('selectstart', function (event) {
        event.stopPropagation();
        return false;
    });

    elem.on ('mousedown', function (event) {
        event.stopPropagation();
        if (disabled)
            return false;

        if (event.buttons !== 1) {
            if (armed) {
                elem.dropClass ('button_down');
                armed = false;
            }
        } else {
            if (!armed) {
                elem.addClass ('button_down');
                armed = true;
            }
        }

        return false;
    });

    function clear(){
        if (!armed)
            return;
        armed = false;
        elem.dropClass ('button_down');
    }
    elem.on ('mouseleave', clear);
    elem.on ('blur', clear);

    elem.on ('mouseup', function (event) {
        event.stopPropagation();
        if (disabled)
            return false;

        if (event.buttons !== 0) {
            if (armed) {
                elem.dropClass ('button_down');
                armed = false;
            }
        } else {
            if (armed) {
                armed = false;
                elem.dropClass ('button_down');
                elem.addClass ('button_pressed');
                if (callback.call (controlFn, selected))
                    selected = true;
                else {
                    selected = false;
                    setTimeout (function(){
                        elem.dropClass ('button_pressed');
                    }, 100);
                }
            }
        }

        return false;
    });

    elem.on ('keydown', function (event) {
        event.stopPropagation();
        if (event.key !== ' ' && event.key !== 'Enter')
            return true;
        if (disabled)
            return false;
        if (armed) {
            elem.dropClass ('button_down');
            armed = false;
        }
        elem.addClass ('button_pressed');
        if (callback.call (controlFn, selected))
            selected = true;
        else {
            selected = false;
            setTimeout (function(){
                elem.dropClass ('button_pressed');
            }, 100);
        }
        return false;
    });

    return controlFn;
}

module.exports = buttonize;
